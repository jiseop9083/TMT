services:
  kafka:
    image: 'apache/kafka:4.1.1'
    container_name: kafka-benchmark
    entrypoint: ["/kafka-entrypoint.sh"]
    environment:
      # KRaft mode settings
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - CLUSTER_ID=abcdefghijklmnopqrstuv

      # Listeners
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT

      # Topic and message settings
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_MESSAGE_MAX_BYTES=15728640
      - KAFKA_REPLICA_FETCH_MAX_BYTES=15728640

      # JVM settings
      - KAFKA_HEAP_OPTS=-Xms1g -Xmx1g

      # JFR settings
      - ENABLE_BROKER_JFR=${ENABLE_BROKER_JFR:-true}
    ports:
      - "9092:9092"
    volumes:
      - ./kafka-entrypoint.sh:/kafka-entrypoint.sh:ro
      - ./profiles/broker:/profiles
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - kafka-network
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 2G
        reservations:
          cpus: '0.75'
          memory: 2G

  producer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        KAFKA_CLIENTS_VERSION: "4.1.1"
        SLF4J_VERSION: "2.0.16"
    image: my-kafka-producer:latest
    container_name: kafka-producer-experiment
    cap_add:
      - NET_ADMIN
    privileged: true
    environment:
      - AUTO_CREATE_TOPICS=${AUTO_CREATE_TOPICS:-true}
      - ENABLE_JFR=${ENABLE_JFR:-true}
      - JAVA_TOOL_OPTIONS=-Xms512m -Xmx512m
      - PROFILES_DIR=/profiles
      - ACKS=${ACKS:-1}
      - REQUEST_TIMEOUT_MS=${REQUEST_TIMEOUT_MS:-15000}
      - DELIVERY_TIMEOUT_MS=${DELIVERY_TIMEOUT_MS:-30000}
      - MAX_BLOCK_MS=${MAX_BLOCK_MS:-15000}
      - SEND_ACK_TIMEOUT_MS=${SEND_ACK_TIMEOUT_MS:-15000}
    volumes:
      - ./profiles:/profiles
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - kafka-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '1.0'
          memory: 1G

networks:
  kafka-network:
    driver: bridge

apiVersion: batch/v1
kind: Job
metadata:
  name: topic-autocreate
  namespace: kafka
spec:
  completions: 5
  parallelism: 1
  completionMode: Indexed
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: topic-autocreate
    spec:
      restartPolicy: Never
      containers:
        - name: autocreate
          image: kafka-autocreate:local
          command: ["bash", "-lc", "/opt/bench/run-autocreate.sh"]
          env:
            - name: BOOTSTRAP
              value: "my-cluster-kafka-bootstrap.kafka.svc:9092"
            - name: TOPIC_PREFIX
              value: "autocreate-test"
            - name: ASYNC_PROFILER_DIR
              value: "/opt/async-profiler"
            - name: JAVA_TOOL_OPTIONS
              value: "-Djava.io.tmpdir=/tmp"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: JOB_COMPLETION_INDEX
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
          envFrom:
            - configMapRef:
                name: topic-autocreate-config
          volumeMounts:
            - name: scripts
              mountPath: /opt/bench
            - name: out
              mountPath: /output
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: scripts
          configMap:
            name: topic-autocreate-scripts
            defaultMode: 0755
        - name: out
          emptyDir: {}
        - name: tmp
          emptyDir: {}
